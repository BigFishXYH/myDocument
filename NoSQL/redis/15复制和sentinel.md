# 复制和sentinel

## 1. 介绍

在生产环境，一台redis服务器一般来说没办法满足我们的需求

- 内存容量不足，对于一台机器来说，内存容量是有限的
- 处理能力不足，因为服务器硬件的限制，配置、网络资源等，一台服务器能处理的命令请求数量也是有限的，当我们需要处理的命令请求数量超过机器能处理的命令请求数量时，一台机器就没办法满足我们的要求了。

为了处理上面问题，我们需要使用redis的多机功能，这些功能的核心目的是将整个数据库分散部署到多台服务器上面，并使用多台服务器来处理命令请求。

- 主从：扩展系统处理请求的能力
- 哨兵：为系统提供高可用特征，减少故障停机出现
- 集群：扩展系统数据库容量以及系统处理读写请求的能力，并提供高可用特征

## 2 . redis sentinel

通过执redis安装文件夹中的redis-sentinel程序，可以启动一个sentinel实例

`redis-sentinel sentinel.conf`

因为redis的sentinel实际上就是一个运行在sentinel模式下的redis服务器，所以我们同样可以用以下命令来启动一个sentinel实例

`redis-server sentinel.conf --sentinel`

该文件记录了要监视的主服务器以及相关配置参数

每个sentinel实例可以监视任意多个主服务器，以及被监视的主服务器属下的所有从服务器

多个sentinel实例可以监视同一个主服务器，监视相同主服务器的这些sentinel们会自动地互相连接，组成一个分布式的sentinel网络，互相通信并交换彼此关于被监视服务器的信息

### 2.1 服务器下线判断

当一个sentinel认为被监视的服务器已经下线时，会向网络中其它sentinel进行确认，判断服务器是否真的已经下线。如果下线服务器为主服务器，那么sentinel网络将对下线主服务器进行自动故障转移：通过将下乡服务器的某从服务器提供为新的服务器，并让其它从服务器转为复制新的服务器，让系统重新回到上线状态 。下线主服务器重新上线时，sentinel会把它变成从服务器

### 2.2 监视配置选项

sentinel在启动时必须指定相应的配置文件： redis-sentinel sentinel.conf

一个sentinel配置文件至少要包含一个监视配置选项，用于指定被监视主服务器的相关信息

sentinel monitor <name> <ip> <port> <quorum>

其中name是用户为被监视主服务器设置的名字，ip和port是被监视主服务器ip地址和端口号，quorum为确认这个主服务器已下线所需要的最少sentinel数量

sentinel可以自动发现并监视主服务器下的所有从服务器，所以用户只需要给出主服务器的地址和端口号就可以了

### 2.3 端口号配置

如果同一台机器上运行多个sentinel实例，用户还需要通过port <number>选项来为每个sentinel设置不同的端口号，如果不进行设置，那么sentinel默认端口号为26379

如果要在同一台机器上运行两个sentinel实例，用户可以通过载入两个配置文件来分别设置不同端口