# 复制和sentinel

## 1. 介绍

在生产环境，一台redis服务器一般来说没办法满足我们的需求

- 内存容量不足，对于一台机器来说，内存容量是有限的
- 处理能力不足，因为服务器硬件的限制，配置、网络资源等，一台服务器能处理的命令请求数量也是有限的，当我们需要处理的命令请求数量超过机器能处理的命令请求数量时，一台机器就没办法满足我们的要求了。

为了处理上面问题，我们需要使用redis的多机功能，这些功能的核心目的是将整个数据库分散部署到多台服务器上面，并使用多台服务器来处理命令请求。

- 主从：扩展系统处理请求的能力
- 哨兵：为系统提供高可用特征，减少故障停机出现
- 集群：扩展系统数据库容量以及系统处理读写请求的能力，并提供高可用特征

## 2. 复制

redis的复制功能允许用户根据一个redis服务器来创建任意多个该服务器的复制品，其中被复制的服务器为主服务器（master），通过复制创建出来的服务器为从服务器（slave）。主从服务器两者拥有相同的数据库数据：只要主从服务器之间的网络连接正常，主服务器就会一直将发生在自己身上的数据更新同步给从服务器，从而一直保证主从服务器的数据相同。

redis允许从服务器执行客户端发送的读命令。通过添加从服务器可以线性的扩展整个系统处理读命令请求的能力。

### 2.1 创建从服务器

redis提供了两种方法来为某主服务器创建从服务器：

1. 使用slaveof <master-ip> <master-port>命令。在将一个服务器设置成从服务器之后，可以通过向他发送slaveof no one来让它变回一个主服务器
2. 在启动服务器时，通过设置slaveof <master-ip> <master-port>配置选项来让服务器成为指定服务器的从服务器

### 2.2 服务器在复制时遭遇下线

在实际的世界中,因 为故障而导致服务器下线的情况总是不可避免的。

在一个由主服 务器和从服务器组成的系统中,主服务器或者从服务器都有可能会下 线,但是不同服 务器下线带来的影响并不相同:

- 如果下线的是从服务器,那么整个系 统处理读请求的性能将有所下降,但 整个系统仍然可以继续处理写请求和读请求,所以这种下线不会导致系统停机;
- 另一方面,因 为在整个系统里面,只有主服 务器一个能够处理写请求,所以如果下 线的是主服务器,那么整个系 统将只能处理读请求而无法处理写请求,导致系统停机。

### 2.3 系统重新上线

为了让系统能够回到正常上线状态(也即是,让系统中的服务器既能够处理读请求,又能够处理写请求),用户需要向系统中的某一个从服 务器发送 SLAVEOF no one 命令,让它变为新的主服务器,并向其他从服务器发送 SLAVEOF 命令,让它们去复制新的从服 务器。

虽然上面介绍的方法可以让系统重新上线,但手动来执行这些操作实在太麻烦了,为此,Redis 提供了 Sentinel 程序,用户可以使用Sentinel 来自动检测主从服务器的状态,并在主服务器下线时,自动执行故障转移操作(failover),让系统重新上线。

## 3. redis sentinel

通过执redis安装文件夹中的redis-sentinel程序，可以启动一个sentinel实例

`redis-sentinel sentinel.conf`

因为redis的sentinel实际上就是一个运行在sentinel模式下的redis服务器，所以我们同样可以用以下命令来启动一个sentinel实例

`redis-server sentinel.conf --sentinel`

该文件记录了要监视的主服务器以及相关配置参数

每个sentinel实例可以监视任意多个主服务器，以及被监视的主服务器属下的所有从服务器

多个sentinel实例可以监视同一个主服务器，监视相同主服务器的这些sentinel们会自动地互相连接，组成一个分布式的sentinel网络，互相通信并交换彼此关于被监视服务器的信息

### 3.1 服务器下线判断

当一个sentinel认为被监视的服务器已经下线时，会向网络中其它sentinel进行确认，判断服务器是否真的已经下线。如果下线服务器为主服务器，那么sentinel网络将对下线主服务器进行自动故障转移：通过将下乡服务器的某从服务器提供为新的服务器，并让其它从服务器转为复制新的服务器，让系统重新回到上线状态 。下线主服务器重新上线时，sentinel会把它变成从服务器

### 3.2 监视配置选项

sentinel在启动时必须指定相应的配置文件： redis-sentinel sentinel.conf

一个sentinel配置文件至少要包含一个监视配置选项，用于指定被监视主服务器的相关信息

sentinel monitor <name> <ip> <port> <quorum>

其中name是用户为被监视主服务器设置的名字，ip和port是被监视主服务器ip地址和端口号，quorum为确认这个主服务器已下线所需要的最少sentinel数量

sentinel可以自动发现并监视主服务器下的所有从服务器，所以用户只需要给出主服务器的地址和端口号就可以了

### 3.3 端口号配置

如果同一台机器上运行多个sentinel实例，用户还需要通过port <number>选项来为每个sentinel设置不同的端口号，如果不进行设置，那么sentinel默认端口号为26379

如果要在同一台机器上运行两个sentinel实例，用户可以通过载入两个配置文件来分别设置不同端口