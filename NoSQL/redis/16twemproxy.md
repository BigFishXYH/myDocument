# twemproxy

实际在使用redis的时候，用户除了会遇到读性能问题，还可能会遇上写性能问题，有时候，用户甚至需要同时扩展系统处理读请求和写请求的能力。

达到这个目的的其中一种方法是使用分片（shard），这项技术的核心原理是将整个数据库分为多个部分，使用不同服务器来储存不同部分，并负责处理相应部分的命令请求（包括读请求和写请求）。

twemproxy是twitter开发的一个代理服务器，，它兼容redis和memcached，允许用户将多个redis服务器添加到一个服务器池里面，并通过用户选择的散列函数和分布函数，将来自客户端的命令请求分发给服务器池中的各个服务器。用户可以直接使用redis客户端连接上twemproxy，并向twemproxy发送命令请求。

## 键分布

当客户端向twemproxy发送一个针对键key的命令请求时，twemproxy会根据以下公式计算出应该由服务器池中的哪个服务器来处理这个命令请求

- 计算键key的散列值
- 根据散列值，计算出键key应该被分布到哪个服务器里面
- 将请求发送给服务器

## 散列函数

twemproxy 提供了多种散列函数供用 户选择,用户可以通过修改配置文件中 hash 选项的值来指定自
己想要使用的散列函数:
- 包括 one at a time 算法在内的 Jenkins 散列函数
- 包括 crc16 、 crc32 和 crc32a 在内的循环冗余校验和函数
- md5 散列算法
- 包括 fnv1_64 、fnv1a_64 、fnv1_32 和 fnv1a_32 在内的 Fowler Noll Vo 散列函数
- 由 Paul Hsieh 发明的 hsieh 散列算法
- murmur 散列算法
  每个散列函数适用的数据 类型、它们的分布率以及 计算速度等情况都不尽相同,用 户可以先了解一下
  这些函数,然后再根据自己的情况来 选择合适的散列函数。

## 分布函数   

用户可以通过修改 distribution 选项的值来改变 twemproxy 分布键的方式,选项的值可以是:
- ketama:一致性 hash ,主要用于在 实现缓存服务时,防止某个服 务器下线而造成缓存大量失效
  http://www.audioscrobbler.net/development/ketama/ 。
- modula:取模运算,相当于依靠散列函数本身来分布各个 键。
- random :不考虑散列值,直接随机地将 键分布到池中的某个服 务器,在访问键时,也随机选择一个
  服务器来进行访问。

## 散列标签

在默认情况下, twemproxy 会根据键的整个键名来计算键的散列值,但如果用户通过 hash_tag 选项
指定了散列标签(hash tag),那么 twemproxy 只会根据键名中被散列标签包围的部分来计算键的散列
值。
举个例子,假设用户设置了配置 hash_tag: "{}" ,那么以下两个 键将计算出相同的散列 值,因为它们散
列标签中包含的内容相同 —— 都是 user :
bbs::{user}::123456
bbs::{user}::255255
而键 bbs::{topic}::98765 则可能会计算出与以上两个 键不同的散列值,因为这个键在散列标签中包含
的内容并不相同。
散列标签可以自由设置,比如对于键 bbs::$user$::123456 就可以使用 “$$” 作为标签、键 bbs::(user)::
123456 就可以使用 “()” 作为标签、而键 bbs::*user*::123456 就可以使用 “**” 作为标签,诸如此类。

## 自动移除下线服务器

为了解决服务器下线的问题,twemproxy 提供了 auto_eject_hosts <bool> 和server_failure_limit <N> 这两个配置选项:当 auto_eject_hosts 选项的值为 true ,并且 twemproxy 在连续 N 次向同一个服 务器发送命令请求但都遇到错误时, twemproxy 就会将该服务器标记为下线,并将原本由这个服务器负责处理的键交给池中的其他在 线的服务器来处理。

## 自动添加重新上线的服务器

twemproxy 提供了 server_retry_timeout <time> 选项, time 参数的格式为毫秒。
当一个服务器被 twemproxy 判断为下线之后,在 time 毫秒之内,twemproxy 不会再尝试向下线的服务
器发送命令请求,但是在 time 毫秒之后,服 务器会尝试重新向下线的服务器发送命令请求:

- 如果命令请求能够正常执行,那么 twemproxy 就会撤销对该服务器的下线判断,并再次将 键交给
  那个服务器来处理。
- 但如果服务器还是不能正常处理命令请求,那么 twemproxy 就会继续将原本应该交给下线服务器
  的键转交给其他服务器来处理,并等待下一次重 试的来临。

