# RDB持久化

rdb持久化功能可以将服务器包含的所有数据以二进制文件的形式保存到硬盘里面。而通过服务器启动时载入rdb文件，服务器可以根据rdb文件的内容，还原服务器原有的数据。

在redis服务器创建rdb文件的情况，最常见的有以下三种：

- 服务器执行客户端发送的save命令
- 服务器执行客户端发送的bgsave命令
- 使用save配置选项设置的自动保存条件被满足，服务器自动执行bgsave。

前两种需要用户手动执行，第三种则是由redis服务器自动执行。

##  save命令

通过使用客户端向服务器发送save命令，命令服务器去创建一个新的rdb文件，在执行save命令的过程中，redis服务器被阻塞，无法处理客户端发送的命令请求，只有在save命令执行完毕之后，服务器才会重新开始处理客户端发送的命令请求。

如果rdb文件已经存在，那么服务器将自动使用新的rdb文件去代替旧的rdb文件。

save命令的复杂度为O(N),N为服务器中，所有数据库包含的键值对数量总和。

## BGSAVE命令

执行BGSAVE命令同样可以创建一个新的rdb文件，这个命令和save命令的区别在于，bgsave不会造成redis服务器阻塞。

bgsave命令不会造成服务器阻塞的原因在于：

1. 当redis服务器接收到bgsave命令的时候，它不会自己来创建rdb文件，而是通过fork()来生成一个子进程，然后由子进程负责创建rdb文件，而自己则继续处理客户端的命令要求。
2. 当子进程创建好rdb文件并退出时，他会向父进程发送一个信号，告知它rdb文件已经创建完毕
3. 最后redis服务器接收子进程创建的rdb文件，bgsave执行完毕

## 自动rdb持久化

以上提到的save和bgsave都是手动操作，他们都需要用户介入，为了让redis服务器可以自动进行rdb持久化操作，redis提供了save配置选项，通过这个选项，用户可以设置任意多个保存条件，每当保存条件中的任意一个被满足时，服务器就会自动执行bgsave命令。

`save <seconds> <changes>`

如果距离上一次创建rdb文件已经过去了seconds秒，并且服务器所有数据库总共已经发生了不少于changes次修改（包括添加、删除、更新），那么执行bgsave 

## rdb持久化的缺点

创建rdb文件需要将服务器所有数据库的数据都保存起来，这是一个非常耗费资源和时间的操作，所以服务器需要隔一段时间才创建一个新的rdb文件，如果过于频繁，会严重影响服务器的性能。

如果在等待创建下一个rdb文件的过程中，服务器遭遇了意外停机，那么用户会丢失最后一次创建rdb文件之后，数据库发生的所有更改。

为了解决rdb持久化在遭遇意外停机丢失大量数据的问题，redis提供了aof持久化功能。aof持久化有一个巨大的优势，用户可以根据需要对aof持久化进行调整，让redis在遭遇意外停机时不丢失任何数据，或者只丢失一秒钟数据，这比rdb持久化遭遇意外停机时，丢失的数据要少得多。

